
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>2016-8 工作笔记 | Eric&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Eric Li">
    

    
    <meta name="description" content="就是工作中遇到的情况记录下来">
<meta property="og:type" content="article">
<meta property="og:title" content="2016-8 工作笔记">
<meta property="og:url" content="http://yoursite.com/2016/08/31/Coding/2016-8-工作笔记/2016-8-工作笔记/index.html">
<meta property="og:site_name" content="Eric's Blog">
<meta property="og:description" content="就是工作中遇到的情况记录下来">
<meta property="og:updated_time" content="2016-08-31T08:19:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2016-8 工作笔记">
<meta name="twitter:description" content="就是工作中遇到的情况记录下来">
<meta name="twitter:creator" content="@https://twitter.com/ericli1235">

    
    <link rel="alternative" href="/atom.xml" title="Eric&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Eric&#39;s Blog" title="Eric&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Eric&#39;s Blog">Eric&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/31/Coding/2016-8-工作笔记/2016-8-工作笔记/" title="2016-8 工作笔记" itemprop="url">2016-8 工作笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Eric Li" target="_blank" itemprop="author">Eric Li</a>
		
  <p class="article-time">
    <time datetime="2016-08-31T08:16:33.000Z" itemprop="datePublished"> 发表于 2016-08-31</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-天气：晴"><span class="toc-number">1.</span> <span class="toc-text">8-1 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-天气：雨-有台风到"><span class="toc-number">2.</span> <span class="toc-text">8-2 天气：雨 有台风到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-天气：阴雨"><span class="toc-number">3.</span> <span class="toc-text">8-3 天气：阴雨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-天气：晴"><span class="toc-number">4.</span> <span class="toc-text">8-4 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-天气：晴"><span class="toc-number">5.</span> <span class="toc-text">8-5 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-天气-晴"><span class="toc-number">6.</span> <span class="toc-text">8-8 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-天气：晴"><span class="toc-number">7.</span> <span class="toc-text">8-9 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-10-天气：晴"><span class="toc-number">8.</span> <span class="toc-text">8-10 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-11-天气：晴"><span class="toc-number">9.</span> <span class="toc-text">8-11 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-12-天气-晴"><span class="toc-number">10.</span> <span class="toc-text">8-12 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-14-天气：阴天"><span class="toc-number">11.</span> <span class="toc-text">8-14 天气：阴天</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-15-天气：晴"><span class="toc-number">12.</span> <span class="toc-text">8-15 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-16-天气：阴"><span class="toc-number">13.</span> <span class="toc-text">8-16 天气：阴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-17-天气-阴"><span class="toc-number">14.</span> <span class="toc-text">8-17 天气:阴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-18-天气：晴"><span class="toc-number">15.</span> <span class="toc-text">8-18 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-19-天气-晴"><span class="toc-number">16.</span> <span class="toc-text">8-19 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-22-天气-晴"><span class="toc-number">17.</span> <span class="toc-text">8-22 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-23-天气-晴"><span class="toc-number">18.</span> <span class="toc-text">8-23 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-24-天气-晴"><span class="toc-number">19.</span> <span class="toc-text">8-24 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-25-天气-晴"><span class="toc-number">20.</span> <span class="toc-text">8-25 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-26-天气-晴"><span class="toc-number">21.</span> <span class="toc-text">8-26 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-29-天气-晴"><span class="toc-number">22.</span> <span class="toc-text">8-29 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-30-天气-阴"><span class="toc-number">23.</span> <span class="toc-text">8-30 天气:阴</span></a></li></ol>
		
		</div>
		
		<h3 id="8-1-天气：晴"><a href="#8-1-天气：晴" class="headerlink" title="8-1 天气：晴"></a>8-1 天气：晴</h3><p>今天在强哥的帮助之下，拿到了暂停状态。挺无语的，要考虑的问题还真多。<br>1 非正常退出，要减去播放时长。目前解决的状态，暂停时候直接退出，可以剔除暂停时间。<br>2 非正常退出，还在播放状态，可以剔除暂停时长。<br>3 正常快进拖动，如果到达最后的时候，立马会触发end，进行上报，但是此时播放器的状态是暂停。再点击一次的话，又会再次触发上报。这个问题有待解决。<br>4 正常结束，可以进行上报。<br>5 暂停时候拖动，到最后的时候，依然会出现这个问题了啦。<br>6 退出的时候，直接执行上报是来不及的，要进行上报就要用线程池来执行。</p>
<a id="more"></a>
<h3 id="8-2-天气：雨-有台风到"><a href="#8-2-天气：雨-有台风到" class="headerlink" title="8-2 天气：雨 有台风到"></a>8-2 天气：雨 有台风到</h3><p>今天是停工的日子。其实也是可以停止打代码的，因为我拿电源的时候拿少了一点东西，但是可以补救的。剩下一点点的任务，那我就得早上把它完成好了。使用fragmentmanager管理fragment的时候，如果在切换的时候就直接调用了fragment里面的方法，是来不及让fragment初始化完毕的。所以，这里我使用的方法就是延时。通过handler去延时执行fragment的操作。要给fragment暴露一个初始化完毕的接口。延时不能太长，不让回影响用户体验。这样子，每个延时片段以后，看看fragment初始化成功，就能调用里面的方法。说改样式，但是这里并没有定义样式，最多只是到了selector的阶段，我总感觉好乱，代码就多了。</p>
<h3 id="8-3-天气：阴雨"><a href="#8-3-天气：阴雨" class="headerlink" title="8-3 天气：阴雨"></a>8-3 天气：阴雨</h3><ul>
<li>说一下今天遇到的问题，我没有对精彩回放的异常情况做好判断，导致app在播放链接不合法的资源时，会崩溃，现在加上如下判断代码<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPlaybackParas</span><span class="params">(VideoReplayBean bean)</span></span>&#123;</div><div class="line">      <span class="keyword">boolean</span> isOk = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">if</span>(bean.getTitle() == <span class="keyword">null</span>)&#123;</div><div class="line">          isOk = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>(bean.getVideoId() == <span class="keyword">null</span>)&#123;</div><div class="line">          isOk = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">try</span>&#123;</div><div class="line">          URL url = <span class="keyword">new</span> URL(bean.getVideoUrl());</div><div class="line">          InputStream in = url.openStream();</div><div class="line">          isOk = <span class="keyword">true</span>;</div><div class="line">      &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">          isOk = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> isOk;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>妈蛋，这个方法是不行的，不要被骗了，现在来个可以用的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkURL</span><span class="params">(String url)</span></span>&#123;</div><div class="line">    <span class="keyword">boolean</span> value=<span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Uri uri = Uri.parse(url);</div><div class="line">        value = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">        value = <span class="keyword">false</span>;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说一下自己在编程上的不足啦。测试思维不够，每次做完的一些，看到正确结果以后，就认为是可以了，但是，这样的东西往往通不过测试。要切记，自己自测以后，确定通过了，才给别人看。</li>
<li>把多余的资源文件删除。如果对模块进行了依赖，是可以使用该模块的东西的。所以，我现在就是要把多于的资源文件进行删除，都加入到qtapplib那个库里面去，全部的顶部tab样式就通过那里去修改就好。</li>
<li>还是要去减少一层的fragment咯。还好之前的那个是空的，我只要去掉activity里面嵌套的fragment，然后将其逻辑移动到activity就好了。</li>
<li>做播放器时间统计的时候，在onStop()里面去使用okhttp执行网络请求，原则上是可以达到目标的。但是项目那里自定了一个方法，在界面被销毁的时候，要撤销全部的网络请求，所以直接进行上报是不行的。我做的事情就是开启一个线程，使用线程池进行操作，然后就不管了啦。</li>
<li>不被那些傻事影响心情，继续学习。</li>
</ul>
<h3 id="8-4-天气：晴"><a href="#8-4-天气：晴" class="headerlink" title="8-4 天气：晴"></a>8-4 天气：晴</h3><p>今天就遇到脏数据的问题了。我先看看。目前就是在下拉刷新的时候，我屏蔽掉第二步的异步请求操作。实质都是一样的啊。不过现在的流程就是，把前面的东西先不显示，等到异步成功的时候，再次进行刷新。</p>
<ul>
<li>今天也是很囧的问题，就是我的下载，数据库写错了，我竟然之前一直都没有发现。数据库进行更新，set的时候set少了一个字段，导致了文件状态一直更新不了。</li>
<li>不小心提交错了代码，除了删除本次提交，还有就是多一次提交，让正确的文件去覆盖掉原来的文件 。</li>
</ul>
<p>比较器啊，再次写，别记错了哦，直接去相减就好<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Comparator&lt;VideoReplayBean&gt; comparator = <span class="keyword">new</span> Comparator&lt;VideoReplayBean&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(VideoReplayBean bean, VideoReplayBean t1)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> t1.getPlayCount() - bean.getPlayCount();</div><div class="line">       &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure></p>
<h3 id="8-5-天气：晴"><a href="#8-5-天气：晴" class="headerlink" title="8-5 天气：晴"></a>8-5 天气：晴</h3><p>时间计时器那里，自己用减法的做法是真的不是太好。我去做一个计时器进行计时。timer那里，我不能使它停止下来。现在改用线程。以下这种方法是不能用的，误差太大，要使用其他的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createThread</span><span class="params">()</span></span>&#123;</div><div class="line">    countTimeRun = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                    countPlayingTimeThread.sleep(<span class="number">1000</span>);</div><div class="line">                &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                playTime1 ++ ;</div><div class="line">                DebugUtils.d(<span class="string">"Eric"</span>,<span class="string">"playTime1="</span> + playTime1);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    countPlayingTimeThread = <span class="keyword">new</span> Thread(countTimeRun);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>虽然可以计时，但是随着cpu的调度，误差变得越来越大，这有往大那边去走，可达10倍，不能被接受。<br>下面写一下计时的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initThread</span><span class="params">()</span></span>&#123;</div><div class="line">       mCountPlayingTimeThread = <span class="keyword">new</span> HandlerThread(<span class="string">"count_playing_time_thread"</span>);</div><div class="line">       mCountPlayingTimeThread.start();</div><div class="line">       looper = mCountPlayingTimeThread.getLooper();</div><div class="line">       mCountTimeHandler = <span class="keyword">new</span> Handler(looper, <span class="keyword">new</span> Handler.Callback() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;<span class="comment">//返回true就不会得到执行了</span></div><div class="line">           &#125;</div><div class="line">       &#125;)&#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">               <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">               <span class="keyword">if</span>(isPlaying)&#123;</div><div class="line">                   <span class="keyword">if</span>(msg.what == MSG_COUNT_TIME)&#123;</div><div class="line">                       playTime1 ++;</div><div class="line">                       DebugUtils.d(<span class="string">"Eric"</span>,<span class="string">"playTime1="</span> + playTime1);</div><div class="line">                       sendEmptyMessageDelayed(MSG_COUNT_TIME,<span class="number">1000</span>);</div><div class="line">                   &#125;</div><div class="line">               &#125;<span class="keyword">else</span> &#123;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>到最后，我因为要精简代码，还是选择了handler加上runnable这个去进行计时。</p>
<h3 id="8-8-天气-晴"><a href="#8-8-天气-晴" class="headerlink" title="8-8 天气:晴"></a>8-8 天气:晴</h3><p>任务下载这里，还是缺乏了网络异常情况的处理。照抄别人的代码，我把timeout设置的时间有点长了，是不是要改一改，先设置10秒合理吧，还是3秒。目前可以捕获到下载的异常，处理的时候，出现了一点问题。我要压压惊，改回去。</p>
<ul>
<li>messenger可能为空，此时是不能发送消息的，不然就会崩溃。在发消息之前，要判定它是不是为空。</li>
<li>分离下载中和下载完成，比较容易管理整个队列</li>
<li>下载中，最后一次ui刷不出来，是因为数据库读取那里出现了问题。在最后一次读取的时候，跳过了为空的读取，所以最后一次更新不了数据。不能把正在下载中队列清空。</li>
<li>初步增加了网络重发机制，可以尝试进行10次重发。重发失败以后，就提示失败。</li>
<li>捕获网络异常，下载中断的时候，尝试进行重发，并且在每次失败的时候，都去保护现场，在真的失败以后，力求下次恢复。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitThread</span> <span class="keyword">extends</span> <span class="title">ThreadPoolTask</span></span>&#123;</div><div class="line">       <span class="keyword">private</span> DownloadFileInfo mFileInfo = <span class="keyword">null</span>;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">InitThread</span><span class="params">(DownloadFileInfo info)</span></span>&#123;</div><div class="line">           <span class="keyword">super</span>(<span class="string">"init_download_file_thread"</span>);</div><div class="line">           <span class="keyword">this</span>.mFileInfo = info;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">private</span> <span class="keyword">int</span> connectTimes = <span class="number">0</span>;</div><div class="line">       OkHttpClient client = BaseDownloadApiClient.getInstance().getClient();</div><div class="line">       RandomAccessFile randomAccessFile = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doTask</span><span class="params">(Object parameter)</span> </span>&#123;</div><div class="line">          initDownload();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">void</span> <span class="title">initDownload</span><span class="params">()</span></span>&#123;</div><div class="line">           Request request = <span class="keyword">new</span> Request.Builder().url(mFileInfo.getFile_url()).get().build();</div><div class="line">           client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Request request, IOException e)</span> </span>&#123;</div><div class="line">                   <span class="keyword">if</span>(connectTimes &lt;<span class="number">10</span>)&#123;</div><div class="line">                       connectTimes++;</div><div class="line">                       DebugUtils.d(<span class="string">"Eric"</span>,<span class="string">"fail connectTimes="</span> + connectTimes);</div><div class="line">                       initDownload();</div><div class="line">                       <span class="comment">// TODO 重发</span></div><div class="line">                   &#125;<span class="keyword">else</span> &#123;</div><div class="line">                       <span class="comment">// 给UI报错</span></div><div class="line">                       sendMessageToUI(UIMessenger,NETWORK_ERROR);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                   <span class="keyword">if</span>(response == <span class="keyword">null</span> || response.body() == <span class="keyword">null</span>)&#123;</div><div class="line">                       sendMessageToUI(UIMessenger,URL_ERROR);</div><div class="line">                       <span class="keyword">return</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">long</span> length = response.body().contentLength();</div><div class="line">                   <span class="keyword">if</span>(length &lt;= <span class="number">0</span>)&#123;</div><div class="line">                       sendMessageToUI(UIMessenger,URL_ERROR);</div><div class="line">                       <span class="keyword">return</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">try</span>&#123;</div><div class="line">                       File dir = <span class="keyword">new</span> File(DOWNLOAD_PATH);</div><div class="line">                       <span class="keyword">if</span>(!dir.exists()) &#123;</div><div class="line">                           <span class="keyword">if</span>(!dir.mkdirs())&#123;</div><div class="line">                               sendMessageToUI(UIMessenger,NOT_ENOUGH_STORAGE);</div><div class="line">                               <span class="keyword">return</span>;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                       File file = <span class="keyword">new</span> File(dir,mFileInfo.getFile_name());</div><div class="line">                       <span class="keyword">if</span>(!file.exists())&#123;</div><div class="line">                           <span class="keyword">if</span>(FileUtil.hasEnoughMemory(file.getAbsolutePath(),length))&#123;</div><div class="line">                               <span class="comment">//文件不存在</span></div><div class="line">                               randomAccessFile = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"rwd"</span>);</div><div class="line">                               <span class="comment">//设置文件大小</span></div><div class="line">                               randomAccessFile.setLength(length);</div><div class="line">                           &#125;<span class="keyword">else</span>&#123;</div><div class="line">                               <span class="comment">//空间不足</span></div><div class="line">                               sendMessageToUI(UIMessenger,NOT_ENOUGH_STORAGE);</div><div class="line">                               <span class="keyword">return</span>;</div><div class="line">                           &#125;</div><div class="line">                       &#125;<span class="keyword">else</span></div><div class="line">                           <span class="comment">//文件已经存在，进行比对，看看是否已经下载完成，crc</span></div><div class="line">                       &#125;</div><div class="line">                       mFileInfo.setFile_length(length);</div><div class="line">                       mFileInfo.setFinished_size(<span class="number">0</span>);</div><div class="line">                       mFileInfo.setLocal_url(file.getAbsolutePath());</div><div class="line">                       mFileInfo.setFile_status(Status.DOWNLOADING);</div><div class="line">                       <span class="keyword">if</span>(mFileInfo != <span class="keyword">null</span> )&#123;</div><div class="line">                           sendStartMsgToHandler(mFileInfo,mHandler,MSG_INIT);</div><div class="line">                           sendMessageToUI(UIMessenger,START_DOWNLOAD_FILE);</div><div class="line">                       &#125;<span class="keyword">else</span>&#123;</div><div class="line">                           <span class="comment">// 给UI报错</span></div><div class="line">                           sendMessageToUI(UIMessenger,NOT_ENOUGH_STORAGE);</div><div class="line">                       &#125;</div><div class="line">                   &#125;<span class="keyword">catch</span> (Throwable e)&#123;</div><div class="line">                       <span class="keyword">if</span>(connectTimes &lt;<span class="number">10</span>)&#123;</div><div class="line">                           connectTimes++;</div><div class="line">                           DebugUtils.d(<span class="string">"Eric"</span>,<span class="string">" task connectTimes="</span> + connectTimes);</div><div class="line">                           initDownload();</div><div class="line">                           <span class="comment">// TODO 重发</span></div><div class="line">                       &#125;<span class="keyword">else</span> &#123;</div><div class="line">                           <span class="comment">// 给UI报错</span></div><div class="line">                           sendMessageToUI(UIMessenger,NOT_ENOUGH_STORAGE);</div><div class="line">                           e.printStackTrace();</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                   &#125;<span class="keyword">finally</span> &#123;</div><div class="line">                       <span class="keyword">if</span>(randomAccessFile != <span class="keyword">null</span>)&#123;</div><div class="line">                           randomAccessFile.close();</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="8-9-天气：晴"><a href="#8-9-天气：晴" class="headerlink" title="8-9 天气：晴"></a>8-9 天气：晴</h3><p>接触的是安卓交叉编译。把一堆的c代码用安卓的编译器，编译成安卓能用的动态库。这样，就有三种方式去做这件事了。搞来搞去，还是强哥给的最后一种通用方法可以解决这个问题。具体流程就是要写一个.sh文件，换掉原来的编译器，使用安卓的编译器去编译。这里要指定的东西挺多的。两个编译器还是有很大的差距的，主要体现就是命令的不同。最多的就是大v变小v。解决了以后，还是有很多的error，要逐个去解决。我跑到最后，发现有一个函数依赖不了。这样，就要在最开始的地方弄弄。还有，今天是7月7，要吃多一点。</p>
<h3 id="8-10-天气：晴"><a href="#8-10-天气：晴" class="headerlink" title="8-10 天气：晴"></a>8-10 天气：晴</h3><p>继续jni的东东，我在强哥指导之下，编译通过了。缺了个库，要添加上去。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">NDK=/Users/lixinkun/android-ndk/android-ndk-r10e</div><div class="line">PLATFORM=$NDK/platforms/android<span class="number">-9</span>/arch-arm</div><div class="line">PREBUILT=$NDK/toolchains/arm-linux-androideabi<span class="number">-4.9</span>/prebuilt/darwin-x86_64/bin</div><div class="line">PREFIX=/Users/lixinkun/Desktop/Faad</div><div class="line"></div><div class="line"><span class="keyword">export</span> LIBS=/Users/lixinkun/android-ndk/android-ndk-r10e/sources/android/support/src/musl-math/<span class="built_in">frexp</span>.c</div><div class="line"><span class="keyword">export</span> CFLAGS=</div><div class="line"></div><div class="line"></div><div class="line">CFLAGS=<span class="string">"-fpic -DANDROID -fpic -mthumb-interwork -ffunction-sections -funwind-tables -fstack-protector -fno-short-enums -D__ARM_ARCH_5__ -D__ARM_ARCH_5T__ -D__ARM_ARCH_5E__ -D__ARM_ARCH_5TE__ -Wno-psabi -march=armv5te -mtune=xscale -msoft-float -mthumb -Os -fomit-frame-pointer -fno-strict-aliasing -finline-limit=64 -DANDROID -Wa,--noexecstack -MMD -MP "</span></div><div class="line">CROSS_COMPILE=$PREBUILT/arm-linux-androideabi-</div><div class="line"><span class="keyword">export</span> CPPFLAGS=<span class="string">"$CFLAGS"</span></div><div class="line"><span class="keyword">export</span> CFLAGS=<span class="string">"$CFLAGS"</span></div><div class="line"><span class="keyword">export</span> CXXFLAGS=<span class="string">"$CFLAGS"</span></div><div class="line"><span class="keyword">export</span> CXX=<span class="string">"$&#123;CROSS_COMPILE&#125;g++ --sysroot=$&#123;PLATFORM&#125;"</span></div><div class="line"><span class="keyword">export</span> LDFLAGS=<span class="string">"$LDFLAGS"</span></div><div class="line"><span class="keyword">export</span> CC=<span class="string">"$&#123;CROSS_COMPILE&#125;gcc --sysroot=$&#123;PLATFORM&#125;"</span></div><div class="line"><span class="keyword">export</span> NM=<span class="string">"$&#123;CROSS_COMPILE&#125;nm"</span></div><div class="line"><span class="keyword">export</span> STRIP=<span class="string">"$&#123;CROSS_COMPILE&#125;strip"</span></div><div class="line"><span class="keyword">export</span> RANLIB=<span class="string">"$&#123;CROSS_COMPILE&#125;ranlib"</span></div><div class="line"><span class="keyword">export</span> AR=<span class="string">"$&#123;CROSS_COMPILE&#125;ar"</span></div><div class="line"><span class="keyword">export</span> LIBS=<span class="string">"$LIBS"</span></div><div class="line"></div><div class="line">./configure --program-prefix=$PREFIX --without-mp4v2 --host=arm-linux</div><div class="line"></div><div class="line"><span class="comment">// make clean</span></div><div class="line"><span class="comment">// make -j4</span></div><div class="line"><span class="comment">// rm -rf $PREFIX</span></div><div class="line"><span class="comment">// mkdir $PREFIX</span></div><div class="line"><span class="comment">// mkdir $PREFIX/include</span></div><div class="line"><span class="comment">// cp ./libfaad/.libs/*.a $PREFIX/</span></div><div class="line"><span class="comment">// cp ./libfaad/.libs/*.so $PREFIX/</span></div><div class="line"><span class="comment">// cp ./include/*.h $PREFIX/include</span></div></pre></td></tr></table></figure></p>
<ul>
<li>对于字符串溢出隐藏的问题，我现在是真的发现之前做错了。设置最大字数去截断是不对的。应该要让安卓自己去弄，设置android:ellipsize=”end” android:lines=”2”就可以。适用于textview和edittext。</li>
<li>排序的问题，又再次被激活，我也是醉了。以后遇到数据排序问题，先让服务端做，自己坚决不做。</li>
<li>jni的调用还真是有点不懂，不能着急，要从hello world开始。</li>
<li>关于jni的编译的坑，是一定要加到jni文件夹里面，才可以编译成功，放到其他文件夹，是不能编译成功了。现在编译出来的.h头文件。</li>
<li>jni工程路径指示不正确，需要重新指定路径，才可以进行编译</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ $NDK/ndk-build NDK_PROJECT_PATH=$XTEMP</div><div class="line">export XTEMP=/cygdrive/D/Workspace/Temp/Hello</div></pre></td></tr></table></figure>
<h3 id="8-11-天气：晴"><a href="#8-11-天气：晴" class="headerlink" title="8-11 天气：晴"></a>8-11 天气：晴</h3><p>今天早上，终于把难过的jni稍微打通一下了。踩坑要点总结，动态注册，函数表的返回值和参数值要写好。网上的那些什么鬼，没有一个系统的介绍。声明和实现放在不同的地方，就是.h和.cpp。动态注册的时候，路径是要直接到类名的，不是到包就行了。我直接上代码了。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">#ifndef HELLO_JNI_TESTJNI_H</div><div class="line">#define HELLO_JNI_TESTJNI_H</div><div class="line">#include &lt;jni.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stddef.h&gt;</div><div class="line">#include "log_util.h"</div><div class="line">#ifdef __cplusplus</div><div class="line">extern "C" &#123;</div><div class="line">#endif</div><div class="line">#define CLASSPATH "com/hello_jni/testjni/TestJni"</div><div class="line">#define true 1</div><div class="line">#define false 0</div><div class="line">#define bool int</div><div class="line">JavaVM* gVm = NULL;</div><div class="line">//一堆的方法声明，实现在cpp那里</div><div class="line">jboolean native_init(JNIEnv* env, jclass clazz);</div><div class="line">jint native_add</div><div class="line">  (JNIEnv *, jclass clazz, jint, jint);</div><div class="line">void native_destroy</div><div class="line">  (JNIEnv *, jclass clazz);</div><div class="line">/**</div><div class="line">* 方法对应表，注意第二个是参数和返回值。</div><div class="line">*/</div><div class="line">static JNINativeMethod method_table[] = &#123;</div><div class="line">        &#123;"init", "()Z", (bool*)native_init&#125;,</div><div class="line">        &#123;"add","(II)I",(int *)native_add&#125;,</div><div class="line">        &#123;"destroy","()V",(void*)native_destroy&#125;,</div><div class="line">&#125;;</div><div class="line">static int registerNativeMethods(JNIEnv* env, jclass clazz, JNINativeMethod* gMethods, int numMethods)</div><div class="line">&#123;</div><div class="line">    if (clazz == NULL) &#123;</div><div class="line">        return JNI_FALSE;</div><div class="line">    &#125;</div><div class="line">    if (env-&gt;RegisterNatives(clazz, gMethods,numMethods) &lt; 0)&#123;</div><div class="line">        return JNI_FALSE;</div><div class="line">    &#125;</div><div class="line">    return JNI_TRUE;</div><div class="line">&#125;</div><div class="line">int clearException(JNIEnv *jenv, bool showEx) &#123;</div><div class="line">    showEx = 0;	// rick</div><div class="line">    jthrowable exception = jenv-&gt;ExceptionOccurred();</div><div class="line">    if (exception != NULL) &#123;</div><div class="line">        if (showEx)&#123;</div><div class="line">            jenv-&gt;ExceptionDescribe();</div><div class="line">        &#125;</div><div class="line">        jenv-&gt;ExceptionClear();</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div><div class="line">static jclass findAppClass(JNIEnv *env, const char *classDesc) &#123;</div><div class="line">    int i;</div><div class="line">    jclass clazzApplicationLoaders = env-&gt;FindClass("android/app/ApplicationLoaders");</div><div class="line">    jthrowable exception = env-&gt;ExceptionOccurred();</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jfieldID fieldApplicationLoaders = env-&gt;GetStaticFieldID(clazzApplicationLoaders,</div><div class="line">                                                             "gApplicationLoaders","Landroid/app/ApplicationLoaders;");</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jobject objApplicationLoaders = env-&gt;GetStaticObjectField(clazzApplicationLoaders,fieldApplicationLoaders);</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jfieldID fieldLoaders = env-&gt;GetFieldID(clazzApplicationLoaders,"mLoaders","Ljava/util/Map;");</div><div class="line">    if (fieldLoaders == NULL) &#123;</div><div class="line">        clearException(env, true);</div><div class="line">        fieldLoaders = env-&gt;GetFieldID(clazzApplicationLoaders,"mLoaders","Landroid/util/ArrayMap;");</div><div class="line">    &#125;</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jobject objLoaders = env-&gt;GetObjectField(objApplicationLoaders,fieldLoaders);</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jclass clazzHashMap = env-&gt;GetObjectClass(objLoaders);</div><div class="line">    jmethodID methodValues = env-&gt;GetMethodID(clazzHashMap, "values", "()Ljava/util/Collection;");</div><div class="line">    jobject values = env-&gt;CallObjectMethod(objLoaders, methodValues);</div><div class="line"></div><div class="line">    jclass clazzValues = env-&gt;GetObjectClass(values);</div><div class="line">    jmethodID methodToArray = env-&gt;GetMethodID(clazzValues,"toArray","()[Ljava/lang/Object;");</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">    jobjectArray classLoaders = (jobjectArray)env-&gt;CallObjectMethod(values,methodToArray);</div><div class="line">    if (clearException(env, true)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int size = env-&gt;GetArrayLength(classLoaders);</div><div class="line"></div><div class="line">    for (i = 0; i &lt; size; i++) &#123;</div><div class="line">        jobject classLoader = env-&gt;GetObjectArrayElement(classLoaders, i);</div><div class="line">        jclass clazzCL = env-&gt;GetObjectClass(classLoader);</div><div class="line">        jmethodID loadClass = env-&gt;GetMethodID(clazzCL, "loadClass","(Ljava/lang/String;)Ljava/lang/Class;");</div><div class="line">        jstring param = env-&gt;NewStringUTF(classDesc);</div><div class="line">        jclass tClazz = (jclass) env-&gt;CallObjectMethod(classLoader, loadClass, param);</div><div class="line">        if (clearException(env, true)) &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line">        return tClazz;</div><div class="line">    &#125;</div><div class="line">    return NULL;</div><div class="line">&#125;</div><div class="line">JNIEXPORT jint JNI_OnLoad(JavaVM* vm, void* reserved)</div><div class="line">&#123;</div><div class="line">    JNIEnv* env = NULL;</div><div class="line">    jint result = -1;</div><div class="line">    gVm = vm;</div><div class="line">    if (vm-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">    jclass clazz = findAppClass(env, CLASSPATH);</div><div class="line">    if (clazz == NULL) &#123;</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line">    registerNativeMethods(env, clazz, method_table, sizeof(method_table) / sizeof(method_table[0]));</div><div class="line">    return JNI_VERSION_1_4;</div><div class="line">&#125;</div><div class="line">#ifdef __cplusplus</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line">#endif //HELLO_JNI_TESTJNI_H</div></pre></td></tr></table></figure></p>
<h3 id="8-12-天气-晴"><a href="#8-12-天气-晴" class="headerlink" title="8-12 天气:晴"></a>8-12 天气:晴</h3><p>今天是周五了，时间过得有点快啊。强哥回来，给我梳理了一下思路，我懂得了录音转码的流程。java层去使用audiorecord进行录音，获得原生的bytes数据，然后源源不断地通过jni，去输送到native层，进行转码，然后生成aac文件。</p>
<ul>
<li>差一点，差一点我就可以去调试库了，jni的通道还是没能够打通，编译一直不通过，我就纳闷了呀。</li>
<li>改去写一下录音的代码，争取把要转码的源数据截取到，为打通压缩代码做好前期准备。快下班了，我也把录音要获取到的字节数组获取到了，一定要用到byte。</li>
</ul>
<h3 id="8-14-天气：阴天"><a href="#8-14-天气：阴天" class="headerlink" title="8-14 天气：阴天"></a>8-14 天气：阴天</h3><p>周末也得干一下活了呀。我尝试了好多次的引用第三方so库，什么静态，动态，一个或者多个.mk文件都试过了，编译还是不会通过。现在，我开始怀疑，这个so应该不是jni规范的第三方库。编写成为静态的库，也试过。囧。我一直觉得自己写的是没有问题的啦，为什么就是不能通过编译呢。</p>
<h3 id="8-15-天气：晴"><a href="#8-15-天气：晴" class="headerlink" title="8-15 天气：晴"></a>8-15 天气：晴</h3><p>我的经验还是有点不足，缺乏了好多的debug经验。我这里一开始就爆了子模块的编译错误，然后我就往里面钻了。然而事实并不是如此，主模块那里有问题。下面列举一下出现的问题：</p>
<ul>
<li>应该是要把编译的路径配置好，ndk那里的路径</li>
<li>Application.mk文件的缺失。这哥们要和Android.mk配套使用的，要放在jni根目录下，一起使用，我之前把它移动到了项目主目录下面，以为万事大吉了，但是不行。</li>
<li><p>依赖库的Android.mk文件编写，这里要进行的就是进行第三方的so库以及其头文件进行依赖。由于这个开源项目编译出来的so库不是jni标准的so库，我这里还要写其他的方法去引用这个库。所以，还是把这个库加上include文件夹下的头文件编译成为动态库，重新写一个别名。打包好，给主so去用。我犯的第一个错就是在这个文件上面，LOCAL_SRC_FILES这里写多了一个local_path的引用，导致路径错误了，不过，这个log竟然打印不出来……</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_MODULE := faacprebuilt</div><div class="line">LOCAL_SRC_FILES := $(FAAC_DIR)/libfaac.so</div><div class="line">LOCAL_EXPORT_C_INCLUDES := $(G_INCLUDES)</div><div class="line">include $(PREBUILT_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
</li>
<li><p>接下来看看主的Android.mk的编写，这里定义了好多的变量。我这里要把所有include的文件路径写好，还有依赖的动态库，对了，就是faacprebuilt这个，做一个引用，就能够使用第三方so库</p>
</li>
<li><p>最后一行，就是叫它继续去找好这个目录下的所有Android.mk文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH := $(call my-dir)</div><div class="line">include $(CLEAR_VARS)</div><div class="line">FAAC_DIR = faac</div><div class="line">G_INCLUDES := \</div><div class="line">    $(LOCAL_PATH)/$(FAAC_DIR)/include \</div><div class="line">LOCAL_MODULE := JniInterface</div><div class="line">LOCAL_SHARED_LIBRARIES := faacprebuilt</div><div class="line">LOCAL_SRC_FILES := JniInterface.cpp</div><div class="line">LOCAL_C_INCLUDES := $(G_INCLUDES)</div><div class="line">LOCAL_LDLIBS := -llog</div><div class="line">include $(BUILD_SHARED_LIBRARY)</div><div class="line">include $(call all-makefiles-under, $(LOCAL_PATH))</div></pre></td></tr></table></figure>
</li>
<li><p>调试的技巧就是，我一开始不怎么明白gcc的，不，是所有的编译原理。这里是先去编译主的Android.mk，才去编译子目录的。但是就有一个问题了，我这里一直报子的错，其实，真的是子的引起的？会不会是主的那里也有问题，牵扯到这里了？把子模块进行屏蔽，先看看主的有没有什么问题啦。果然，是没有什么问题的，就是子模块编译不过而已。我有一点搞不清楚的就是，我那里为什么不会提示是faac.so编译不通过呢？一直都说wrong format。好郁闷。这里编译过程不了解，可能被其他错误先掩盖去了。所以，这里要做的就是，把真正的第一步报错找到，逐步去解决。</p>
</li>
<li>介绍一下Android.mk里面的log方法，这个在编译过程中很重要。$(warning $(变量))或者$(info $(变量))</li>
<li><p>遭遇到的另外一个问题，就是使用ide去创建jni文件夹的时候，丫的，创建的竟然是不同颜色的jni文件夹，这是什么鬼？后来改了一下，就没有报错了。我知道这个原因错在哪里了，就是路径没有指对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sourceSets &#123;</div><div class="line">        main &#123;</div><div class="line">            jniLibs.srcDirs = [<span class="string">'libs'</span>]</div><div class="line">            jni.srcDirs = [<span class="string">'src/main/jni'</span>]</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>写了这么久，我才发现是自己的函数注册有问题了。字符串的参数不是S，而是(Ljava/lang/String;)，一定要加括号。这样就不会报注册错误了。</p>
</li>
<li>今晚，把库再写成动态库去做试试看。后来我的经验告诉我，编译成为动态库是行不通的，只能把它编译成为静态库。</li>
<li>在调试之中，卡住了，就是不知道怎么样去调试c++代码。网上说要用gdb，但是并不推荐用这个东西，我不会啊。后来，还是使用了安卓自带的jni打印出log。…………  搞了好久，明白了一点点安卓log在jni中的作用，要像c的printf那样，指定输出格式，才能够对变量进行输出。</li>
<li>踩坑好像踩完了，是不是？我把所有的初始化信息，全他妈都写进去了编译的那里，所以才会导致那么慢的。每次都去搞初始化？别逗了，把所有的代码都抽走，放到初始化函数那里就好。</li>
</ul>
<h3 id="8-16-天气：阴"><a href="#8-16-天气：阴" class="headerlink" title="8-16 天气：阴"></a>8-16 天气：阴</h3><p>一大早就起来了，为昨天能够弄出点东西到内存卡而睡不着啦。大小差距太大，我也播放不了，要再次进行检查。今天编程要点</p>
<ul>
<li>temp要不要删，是看你每次是不是都是重新申请的。</li>
<li>目前转码到的东西，是会丢包的，最前面的两段字节没有被转码，明显丢包了。不过这样貌似是正常现象，那就证明我的编码函数还是有问题。其实是参数的问题。我就晕了。我也知道参数的问题，但是就是不清楚怎么去改。</li>
<li>不要相信百度，相信谷歌就好。</li>
<li>写文件的时候，如果长度是0，就千万不要去写。</li>
<li>目前最新进展，audiotrack貌似不支持aac音频的播放。事实也确实如此，我换成MediaPlayer就能够进行音频播放。还有的一个问题就是，变声和速率不一样了。那，就是参数设置得不对了哦。参数设置那里一定要设置正确，才能够进行编码。</li>
<li>遇到MediaPlayer不能创建的问题，除了代码问题，还有就是音频源的问题。音频有错的话，是不能创建对象的，要切记。</li>
<li>使用一下ffmpeg去查看它的参数，然而并看不到。</li>
<li>改了参数，现在声音播放音色正常，但是一卡一卡的了。</li>
<li>debug看到faacEncEncode返回的压缩码是0，并不代表压缩是已经失败，是可以正常进行的。等到两帧过后吧，就会有东西返回。我所要做的，就是将返回值不为0的那些写入到文件，最后保存起来就好了。具体为什么返回0，我估计就是一两帧的时候，其内部的缓冲区并没有被填满，不返回编码成功的数目。</li>
</ul>
<h3 id="8-17-天气-阴"><a href="#8-17-天气-阴" class="headerlink" title="8-17 天气:阴"></a>8-17 天气:阴</h3><p>目前的压缩就是有两种音效，一种就是不断，但是变声。另外一种就是不变声，但是会断，卡顿的那种感觉。这两种都是我自己捣鼓出来的音效，还没有发现原因。参数设置还是不正确。</p>
<ul>
<li>从手机中拷贝文件出去到文件夹，使用的是adb pull命令，但是要注意的一点就是不能在adb shell的环境下使用，要在终端下使用这个命令。</li>
<li>问题探究，会不会是音频源的问题？我得去看看我录制的pcm文件到底有没有很大的坑，是不是标准的pcm文件。</li>
<li>强哥说了，安卓自带的东西当然是可以播放，不能用自己弄出来的一套东西去验证。</li>
<li>目前遇到的错误就是signal 11问题，主要就是jni的代码有问题，可能是指针使用不正确。操作了已经被删除的指针。</li>
<li>看到了，看到了，是码率不对应。<br>华丽的分割线—————————————————————————-<br>开启新的东西，这里晚上有空再弄</li>
<li>layoutAnimation可以对一组的组件统一实现动画，也可以自定义播放的顺序。<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0619/3090.html" target="_blank" rel="external">layoutAnimation使用简介</a></li>
<li>指示器如果要使用的话，就要先去看看这个东西<a href="http://www.jianshu.com/users/f0a3fb1abaed/latest_articles" target="_blank" rel="external">viewpager使用简介</a></li>
</ul>
<h3 id="8-18-天气：晴"><a href="#8-18-天气：晴" class="headerlink" title="8-18 天气：晴"></a>8-18 天气：晴</h3><ul>
<li>说正事。现在由于产品的配置不正确，也不是说不正确，是手机和平板都使用了同一个authority，导致两个玩意不能装在一起，所以要去配置文件那里修改。然后，还要去初始化文件那里指定不同路径的东东。可是，cp的初始化是最快的，任何动态获取到的东西都不行，都是为空。转变思路哈，在cp那里获取包名，直接重定向过去。</li>
<li>使用的时候，cp里面定义的authority就不起作用了，要实时去使用另外一个东西。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertDonwloadFileInfoifNotExists</span><span class="params">(DownloadFileInfo downloadFileInfo)</span></span>&#123;</div><div class="line">       ContentValues contentValues = DownloadContentProvider.DownloadFileInfoToContentValues(downloadFileInfo);</div><div class="line">       mContext.getContentResolver().insert(Uri.parse(<span class="string">"content://"</span>+ProjectConfig.packageName + <span class="string">".DownloadContentProvider"</span>+<span class="string">"/"</span>+DownloadContentProvider.DOWNLOADED_FILE_INFO),contentValues);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>讨论来讨论去，我的方案可能全部被推翻了。有几点需要注意的：</p>
<ul>
<li>开启多个任务的时候，写数据库会丢掉一部分数据，需要查找出来。我现在的策略就是写每个任务的数据库都分配一个线程去写数据库，仔细测试一下，看看会不会再丢。我事实上已经分线程了，没有认真测试过。</li>
<li>有可能被多线程操作的域，都要进行同步。不过同步的开销很大，真的值得？</li>
<li>界面要进行局部刷新，不能每次都刷新全局。</li>
<li>baseapplication那里，创建新的进程，不能让它走init()流程，不然会创建多很多东西，消耗性能</li>
<li>尝试的时候，要把失败的重连次数在成功连接以后进行重置，让其为0.</li>
<li>代码错误,如果前者被抛出异常，后者就不能执行，要try两次。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">if</span>(inputStream != <span class="keyword">null</span>)&#123;</div><div class="line">          inputStream.close();</div><div class="line">      &#125;</div><div class="line">     <span class="keyword">if</span>(randomAccessFile != <span class="keyword">null</span>)&#123;</div><div class="line">          randomAccessFile.close();</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>正确写法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span>(inputStream != <span class="keyword">null</span>)&#123;</div><div class="line">            inputStream.close();</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">        <span class="keyword">if</span>(randomAccessFile != <span class="keyword">null</span>)&#123;</div><div class="line">                randomAccessFile.close();</div><div class="line">          &#125;</div><div class="line">        &#125;<span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="8-19-天气-晴"><a href="#8-19-天气-晴" class="headerlink" title="8-19 天气:晴"></a>8-19 天气:晴</h3><ul>
<li>复制害死人咯，我把ui转移到平板和手机端，用了复制，导致R文件没有更新，都在报找不到的错误。</li>
<li><p>创建新的进程的时候，是不能够再继续走baseapplication的init路线，我把自己的进程给屏蔽掉以后，就不会再走init路线。但是问题又来了，我要访问的报名是要走baseapplication的init那里才能获取到的，所以在新进程中获取本app的包名就返回个null的值。正确做法，屏蔽还是要有的,就是把projectconfig的初始化提前。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始化项目配置</span></div><div class="line">      instance = <span class="keyword">this</span>;</div><div class="line">      ProjectConfig.init(<span class="keyword">this</span>);</div><div class="line">      <span class="keyword">if</span> (processName != <span class="keyword">null</span> &amp;&amp; processName.contains(<span class="string">":downloadprocress"</span>)) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">this</span>.init();</div></pre></td></tr></table></figure>
<h3 id="8-22-天气-晴"><a href="#8-22-天气-晴" class="headerlink" title="8-22 天气:晴"></a>8-22 天气:晴</h3><p>今天犯的错误，就是我写的东西造成了多线程操作list，这个可能会造成主线程阻塞。强哥给出的建议，就是要把对线程的管理都抽出去到一个独立的类，去那里进行下载。</p>
</li>
<li>使用binder去进行通信，要管理通信对象队列了。思路就是，不用自己在界面消失的时候直接解绑（发送解绑信息），主动去判断messenger对象是否还存活就可以了。</li>
<li>做界面的时候，怎么让一个activity和一串的fragment进行通信呢？我采用的方法比较笨，只是把fragment位置和它所要被调用的方法暴露了出来，同时，应该要注意的就是，在编辑状态的时候要禁止viewpager的滑动。</li>
<li>我的线程管理有很大的混乱，就是主线程和子线程同时在操作了一个对象。我乍一看是没什么问题，但是操作频繁了以后，非常有可能会造成主线程阻塞。这很关键，暴露出了自己对线程管理的不熟悉，还有就是对性能的不重视。</li>
</ul>
<h3 id="8-23-天气-晴"><a href="#8-23-天气-晴" class="headerlink" title="8-23 天气:晴"></a>8-23 天气:晴</h3><p>早上就把messager的binder通信方式打通了，但是还是有点问题的就是队列管理纳闷。</p>
<ul>
<li>同一个进程内，message的obj可以是任意的对象，跨进程就要是实现了序列化的对象。</li>
<li><p>bindservice也会走onCreate流程。写一个单例，写一个多核心处理器也不怕的单例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DownloadTaskManager <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">synchronized</span> (DownloadTaskManager.class)&#123;</div><div class="line">                <span class="keyword">if</span>(instance == <span class="keyword">null</span>)&#123;</div><div class="line">                    instance = <span class="keyword">new</span> DownloadTaskManager();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>什么鬼，点击事件不响应了。</p>
</li>
<li>找到了更新不了状态的尴尬，我在移除信息的时候，先把观察者给干掉了，导致最后一次刷新刷新不了。执行顺序啊，怎么安排才是个正确的</li>
</ul>
<h3 id="8-24-天气-晴"><a href="#8-24-天气-晴" class="headerlink" title="8-24 天气:晴"></a>8-24 天气:晴</h3><p>UI布好了没有？好了。数据库改好了没有？没有。今天的任务就是把数据库给翻一个天，不用cp了。<br>使用ormlite的时候，bean需要一个无参的构造方法。<br>ormlite那里写的通用方法，查询为空的时候，返回为null。</p>
<h3 id="8-25-天气-晴"><a href="#8-25-天气-晴" class="headerlink" title="8-25 天气:晴"></a>8-25 天气:晴</h3><p>出现严重的教学事故，类执行初始化，然后就没有下文了，我草。</p>
<p>数据库，是用到的时候还会进行创建。我的进程被过滤了，就没有被创建数据库。</p>
<p>错误原来就是在子线程里面使用了handler，没有使用looper导致的异常。</p>
<p>把所有的队列管理，都独立到一个线程里面去做。</p>
<p>facebook的东西就是不人性化，这玩意不使用最新的chrome浏览器就不能用，真是累。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#stetho开关,ture且编译debug版本时,stetho启动</div><div class="line">#chrome://inspect/#devices</div><div class="line">STETHO_ENABLE = true</div></pre></td></tr></table></figure></p>
<p>写了一下午，都是数据库惹的祸，好多操作都改变了，我还没有一一统一过来</p>
<h3 id="8-26-天气-晴"><a href="#8-26-天气-晴" class="headerlink" title="8-26 天气:晴"></a>8-26 天气:晴</h3><p>数据库出乱子了，那是什么鬼？10分钟后找到错误了，因为ormlite需要指定一个主键。这个主键和我的线程id之前是杂糅的，我改了一个键。然后数据库操作那里没有去更新键，导致数据库操作出错了。</p>
<ul>
<li>接下来的工作，就是交互的提示信息。要进行通知。</li>
<li>service死的时候，我该怎么去保存信息？不需要保存，换一种方式，去曲线救国。可以在下次再次进来的时候，对之前的状态去做成暂停。这个是一种思路，但是走不通。</li>
<li>强哥说了一下，我好像懂了网络软件进行限速的原理。当然我们是不能够去修改电线杆的速度的。</li>
</ul>
<h3 id="8-29-天气-晴"><a href="#8-29-天气-晴" class="headerlink" title="8-29 天气:晴"></a>8-29 天气:晴</h3><p>一直都想要说去写一下总结，但是一直都说没时间。额，真的没时间？<br>今天的坑：</p>
<ul>
<li>全选按钮的选择问题，我不知道现在算是解决了没有，初步可以达成使用，先记下。</li>
<li>批量删除的问题，我就老说为什么会漏掉一些东西。那就，不去遍历数组了，转而去遍历hashmap，这样看看能不能找到另外一个突破口。事实上是可以的，我现在能够进行批量删除了。</li>
<li>数据库的操作问题，现在的问题就是建立数据库都是跟着用户和角色走，要去创建一个通用数据库，与用户无关的就好。</li>
<li>最大的问题来了，就是禁止viewpager的左右滑动的同时，又要去不禁止它的左右滑动。要做的事情就是去重新写viewpager的拦截事件，让它只能够拦截左右滑动，不拦截上下滑动。</li>
</ul>
<h3 id="8-30-天气-阴"><a href="#8-30-天气-阴" class="headerlink" title="8-30 天气:阴"></a>8-30 天气:阴</h3><ul>
<li><p>滑动的时候出现问题，我就是撸了这几行代码下去，然后就奇迹般解决了，还不会有很多的后遗症，很好用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollTo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span>(isPagingEnabled)&#123;</div><div class="line">           <span class="keyword">super</span>.scrollTo(x, y);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentItem</span><span class="params">(<span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span>(isPagingEnabled)&#123;</div><div class="line">           <span class="keyword">super</span>.setCurrentItem(item);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>剩下就是全选的问题了，我要再次去看看是什么问题。</p>
</li>
<li>产品那边就说了要做成滑动就退出编辑状态。一开始我的内心是拒绝的，我花了那么久的时间去研究事件分发机制，虽然也没什么成果，但是要改，还是有精力去应付的。我把那些状态都恢复就ok了。</li>
<li>发了两个bug过来，额，基本不算bug的吧。先去搞定产品，然后就能够放开手脚去做了。</li>
</ul>
<p>8-31 天气:阴天<br>今天的任务暂时想到的就是下载任务的抢占优先级。就是要去搞队列里面的东西，同时同步到数据库和界面啦啦啦。思路就是找到正在下载的任务，停掉但不移出队列，刷界面。找到等待的任务，开始，刷界面。一直卡在开始失败的阴影。</p>
<ul>
<li>进行到的状态，抢占以后恢复不了状态。</li>
<li>可能找到问题所在了，我这里是给了个开关停掉所有的线程。重启的时候，忘记关掉，所以线程是不可能启动起来的。现在，情况看起来就好了很多了，起码我可以进行抢占，不过，刚才弹出的下载失败是什么鬼？不是很能每次都复现，我也不确定是真的网络失败。</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/work/">work</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2016/08/31/Coding/2016-8-工作笔记/2016-8-工作笔记/" data-title="2016-8 工作笔记 | Eric&#39;s Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/09/03/2016/寻求改变，才是进步/寻求改变，才是进步/" title="寻求改变，才是进步">
  <strong>上一篇：</strong><br/>
  <span>
  寻求改变，才是进步</span>
</a>
</div>


<div class="next">
<a href="/2016/07/29/my university/2015/2015-In-ShenZhen/2015-In-ShenZhen/"  title="2015 In ShenZhen">
 <strong>下一篇：</strong><br/> 
 <span>2015 In ShenZhen
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-天气：晴"><span class="toc-number">1.</span> <span class="toc-text">8-1 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-天气：雨-有台风到"><span class="toc-number">2.</span> <span class="toc-text">8-2 天气：雨 有台风到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-天气：阴雨"><span class="toc-number">3.</span> <span class="toc-text">8-3 天气：阴雨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-天气：晴"><span class="toc-number">4.</span> <span class="toc-text">8-4 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-天气：晴"><span class="toc-number">5.</span> <span class="toc-text">8-5 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-天气-晴"><span class="toc-number">6.</span> <span class="toc-text">8-8 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-天气：晴"><span class="toc-number">7.</span> <span class="toc-text">8-9 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-10-天气：晴"><span class="toc-number">8.</span> <span class="toc-text">8-10 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-11-天气：晴"><span class="toc-number">9.</span> <span class="toc-text">8-11 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-12-天气-晴"><span class="toc-number">10.</span> <span class="toc-text">8-12 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-14-天气：阴天"><span class="toc-number">11.</span> <span class="toc-text">8-14 天气：阴天</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-15-天气：晴"><span class="toc-number">12.</span> <span class="toc-text">8-15 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-16-天气：阴"><span class="toc-number">13.</span> <span class="toc-text">8-16 天气：阴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-17-天气-阴"><span class="toc-number">14.</span> <span class="toc-text">8-17 天气:阴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-18-天气：晴"><span class="toc-number">15.</span> <span class="toc-text">8-18 天气：晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-19-天气-晴"><span class="toc-number">16.</span> <span class="toc-text">8-19 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-22-天气-晴"><span class="toc-number">17.</span> <span class="toc-text">8-22 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-23-天气-晴"><span class="toc-number">18.</span> <span class="toc-text">8-23 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-24-天气-晴"><span class="toc-number">19.</span> <span class="toc-text">8-24 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-25-天气-晴"><span class="toc-number">20.</span> <span class="toc-text">8-25 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-26-天气-晴"><span class="toc-number">21.</span> <span class="toc-text">8-26 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-29-天气-晴"><span class="toc-number">22.</span> <span class="toc-text">8-29 天气:晴</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-30-天气-阴"><span class="toc-number">23.</span> <span class="toc-text">8-30 天气:阴</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="https://github.com/Eric1235" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/life/" title="life">life<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/college/" title="college">college<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/work/" title="work">work<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/coding/" title="coding">coding<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/study/" title="study">study<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/me/" title="me">me<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/improve/" title="improve">improve<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/coding-android/" title="coding android">coding android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/work-life/" title="-work -life">-work -life<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/work-coding/" title="-work -coding">-work -coding<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/fight/" title="fight">fight<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/sunshine/" title="sunshine">sunshine<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Be Fearless <br/>
			Be an Engineer</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/Eric1235" target="_blank" class="icon-github" title="github"></a>
		
		
		
		<a href="https://twitter.com/https://twitter.com/ericli1235" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/https://www.facebook.com/lixinkun" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		
		
		
		
		<a href="mailto:Eric1235@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="Eric Li">Eric Li</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
